{% extends "base.html" %}

{% block title %}Website Speed Tester - Core Web Vitals Analyzer{% endblock %}

{% block meta_description %}Test your website speed and Core Web Vitals performance. Get detailed insights, optimization suggestions, and competitive analysis to improve page load times.{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 text-white py-20">
    <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6">
                Website Speed Tester
            </h1>
            <p class="text-xl mb-8 text-blue-100">
                Analyze your website's performance, Core Web Vitals, and get actionable optimization recommendations
            </p>
            
            <!-- Speed Test Form -->
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-8 max-w-3xl mx-auto">
                <form id="speed-test-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Website URL</label>
                        <input 
                            type="url" 
                            id="url-input" 
                            name="url"
                            placeholder="https://example.com" 
                            class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                            required
                        >
                    </div>
                    
                    <!-- Test Options -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Analysis Type</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label class="flex items-center space-x-3 bg-white/10 p-4 rounded-lg cursor-pointer hover:bg-white/20 transition-colors">
                                <input type="radio" name="test_type" value="basic" checked class="text-blue-600">
                                <div>
                                    <div class="font-medium">Basic Speed Test</div>
                                    <div class="text-sm text-blue-200">Load time and basic metrics</div>
                                </div>
                            </label>
                            <label class="flex items-center space-x-3 bg-white/10 p-4 rounded-lg cursor-pointer hover:bg-white/20 transition-colors">
                                <input type="radio" name="test_type" value="core_web_vitals" class="text-blue-600">
                                <div>
                                    <div class="font-medium">Core Web Vitals</div>
                                    <div class="text-sm text-blue-200">LCP, FID, CLS analysis</div>
                                </div>
                            </label>
                            <label class="flex items-center space-x-3 bg-white/10 p-4 rounded-lg cursor-pointer hover:bg-white/20 transition-colors">
                                <input type="radio" name="test_type" value="comprehensive" class="text-blue-600">
                                <div>
                                    <div class="font-medium">Comprehensive (Pro)</div>
                                    <div class="text-sm text-blue-200">Full analysis & insights</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <button 
                        type="submit" 
                        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105"
                    >
                        <i data-lucide="zap" class="w-5 h-5 mr-2 inline"></i>
                        Test Website Speed
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Results Section -->
<section id="results-section" class="py-16 bg-gray-50" style="display: none;">
    <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
            
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-600">Testing website speed...</p>
                <p class="text-sm text-gray-500 mt-2">This may take up to 30 seconds</p>
            </div>
            
            <!-- Results Content -->
            <div id="results-content" style="display: none;">
                
                <!-- Overall Performance Score -->
                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Performance Score</h2>
                        <div class="flex justify-center items-center space-x-8">
                            <div class="relative">
                                <svg class="w-32 h-32 transform -rotate-90">
                                    <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" class="text-gray-200"/>
                                    <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" 
                                            class="text-blue-600" stroke-linecap="round" 
                                            id="performance-circle"
                                            stroke-dasharray="351.86" 
                                            stroke-dashoffset="351.86"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="performance-score" class="text-3xl font-bold text-gray-800">0</span>
                                </div>
                            </div>
                            <div class="text-left">
                                <div id="performance-grade" class="text-lg font-semibold mb-2">Calculating...</div>
                                <div id="performance-details" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Core Metrics Cards -->
                <div id="core-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Metrics will be populated by JavaScript -->
                </div>
                
                <!-- Analysis Tabs -->
                <div class="bg-white rounded-xl shadow-lg mb-8">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6" aria-label="Tabs">
                            <button class="speed-tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600" data-tab="overview">
                                Overview
                            </button>
                            <button class="speed-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="core-web-vitals">
                                Core Web Vitals
                            </button>
                            <button class="speed-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="technical">
                                Technical Details
                            </button>
                            <button class="speed-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="opportunities">
                                Optimization
                            </button>
                            <button class="speed-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="competitive">
                                Competitive (Pro)
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Tab Content -->
                    <div class="p-6">
                        <!-- Overview Tab -->
                        <div id="overview-tab" class="speed-tab-content">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Performance Overview</h3>
                            <div id="overview-content" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Core Web Vitals Tab -->
                        <div id="core-web-vitals-tab" class="speed-tab-content hidden">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Core Web Vitals Analysis</h3>
                            <div id="cwv-content" class="space-y-6">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Technical Tab -->
                        <div id="technical-tab" class="speed-tab-content hidden">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Technical Analysis</h3>
                            <div id="technical-content" class="space-y-6">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Opportunities Tab -->
                        <div id="opportunities-tab" class="speed-tab-content hidden">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Optimization Opportunities</h3>
                            <div id="opportunities-content" class="space-y-6">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Competitive Tab -->
                        <div id="competitive-tab" class="speed-tab-content hidden">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Competitive Analysis</h3>
                            <div id="competitive-content" class="space-y-6">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Upgrade Notice for Free Users -->
<div id="upgrade-notice" class="fixed bottom-4 right-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 rounded-lg shadow-lg max-w-sm" style="display: none;">
    <div class="flex items-start space-x-3">
        <i data-lucide="star" class="w-6 h-6 text-yellow-300 flex-shrink-0 mt-0.5"></i>
        <div>
            <h4 class="font-semibold text-sm">Unlock Advanced Analytics</h4>
            <p class="text-xs text-purple-100 mt-1">Get comprehensive performance insights, competitive analysis, and priority optimization recommendations.</p>
            <a href="/pricing" class="inline-block mt-2 bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-xs font-medium transition-colors">
                Upgrade Now
            </a>
        </div>
        <button onclick="document.getElementById('upgrade-notice').style.display='none'" class="text-purple-200 hover:text-white">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
    </div>
</div>

<style>
.speed-tab-content {
    min-height: 300px;
}

.metric-card {
    transition: transform 0.2s ease-in-out;
}

.metric-card:hover {
    transform: translateY(-2px);
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-good { background-color: #10b981; }
.status-needs_improvement { background-color: #f59e0b; }
.status-poor { background-color: #ef4444; }
.status-excellent { background-color: #10b981; }
.status-warning { background-color: #f59e0b; }
.status-error { background-color: #ef4444; }

.cwv-metric {
    border-left: 4px solid #e5e7eb;
    padding-left: 1rem;
}

.cwv-metric.good { border-left-color: #10b981; }
.cwv-metric.needs_improvement { border-left-color: #f59e0b; }
.cwv-metric.poor { border-left-color: #ef4444; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('speed-test-form');
    const urlInput = document.getElementById('url-input');
    const resultsSection = document.getElementById('results-section');
    const loadingState = document.getElementById('loading-state');
    const resultsContent = document.getElementById('results-content');
    
    let currentTestData = null;
    
    // Tab functionality
    const tabButtons = document.querySelectorAll('.speed-tab-button');
    const tabContents = document.querySelectorAll('.speed-tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.getAttribute('data-tab');
            
            // Update button states
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            button.classList.add('active', 'border-blue-500', 'text-blue-600');
            button.classList.remove('border-transparent', 'text-gray-500');
            
            // Update content visibility
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
        });
    });
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const url = formData.get('url').trim();
        const testType = formData.get('test_type');
        
        if (!url) {
            alert('Please enter a website URL');
            return;
        }
        
        // Show results section and loading state
        resultsSection.style.display = 'block';
        loadingState.style.display = 'block';
        resultsContent.style.display = 'none';
        
        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth' });
        
        try {
            let endpoint = '';
            switch(testType) {
                case 'basic':
                    endpoint = '{{ url_for("speed_tester.analyze_speed") }}';
                    break;
                case 'core_web_vitals':
                    endpoint = '{{ url_for("speed_tester.analyze_core_web_vitals") }}';
                    break;
                case 'comprehensive':
                    endpoint = '{{ url_for("speed_tester.get_performance_insights") }}';
                    break;
                default:
                    endpoint = '{{ url_for("speed_tester.analyze_speed") }}';
            }
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentTestData = data;
                displayResults(data, testType);
            } else {
                throw new Error(data.error || 'Speed test failed');
            }
            
        } catch (error) {
            console.error('Error:', error);
            showError('Failed to test website speed. Please check the URL and try again.');
        } finally {
            loadingState.style.display = 'none';
        }
    });
    
    function displayResults(data, testType) {
        resultsContent.style.display = 'block';
        
        // Display performance score
        let score = 0;
        if (testType === 'core_web_vitals') {
            score = data.cwv_score || 0;
        } else if (testType === 'comprehensive') {
            score = data.performance_summary?.speed_score || 0;
        } else {
            score = data.overall_score || 0;
        }
        
        document.getElementById('performance-score').textContent = score;
        updatePerformanceCircle(score);
        updatePerformanceGrade(score);
        
        // Populate core metrics
        populateCoreMetrics(data, testType);
        
        // Populate tab content based on test type
        if (testType === 'basic') {
            populateBasicAnalysis(data);
        } else if (testType === 'core_web_vitals') {
            populateCoreWebVitalsAnalysis(data);
        } else if (testType === 'comprehensive') {
            populateComprehensiveAnalysis(data);
        }
        
        // Show upgrade notice for free users on comprehensive test
        if (testType === 'comprehensive' && data.user_type === 'free') {
            setTimeout(() => {
                document.getElementById('upgrade-notice').style.display = 'block';
            }, 3000);
        }
    }
    
    function updatePerformanceCircle(score) {
        const circle = document.getElementById('performance-circle');
        const circumference = 2 * Math.PI * 56;
        const offset = circumference - (score / 100) * circumference;
        circle.style.strokeDashoffset = offset;
        
        // Color based on score
        if (score >= 80) {
            circle.classList.remove('text-yellow-500', 'text-red-500');
            circle.classList.add('text-green-500');
        } else if (score >= 60) {
            circle.classList.remove('text-green-500', 'text-red-500');
            circle.classList.add('text-yellow-500');
        } else {
            circle.classList.remove('text-green-500', 'text-yellow-500');
            circle.classList.add('text-red-500');
        }
    }
    
    function updatePerformanceGrade(score) {
        const grade = document.getElementById('performance-grade');
        const details = document.getElementById('performance-details');
        
        if (score >= 90) {
            grade.textContent = 'Excellent (A+)';
            grade.className = 'text-lg font-semibold mb-2 text-green-600';
            details.textContent = 'Outstanding performance! Your site loads very fast.';
        } else if (score >= 80) {
            grade.textContent = 'Good (A)';
            grade.className = 'text-lg font-semibold mb-2 text-green-600';
            details.textContent = 'Good performance with minor optimization opportunities.';
        } else if (score >= 60) {
            grade.textContent = 'Needs Improvement (B)';
            grade.className = 'text-lg font-semibold mb-2 text-yellow-600';
            details.textContent = 'Several optimization opportunities available.';
        } else {
            grade.textContent = 'Poor (C-F)';
            grade.className = 'text-lg font-semibold mb-2 text-red-600';
            details.textContent = 'Significant performance improvements needed.';
        }
    }
    
    function createMetricCard(title, value, unit, status, description, icon = 'activity') {
        const statusClass = `status-${status || 'good'}`;
        
        return `
            <div class="metric-card bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="${icon}" class="w-5 h-5 text-gray-600"></i>
                        <h4 class="font-medium text-gray-700">${title}</h4>
                    </div>
                    <span class="status-indicator ${statusClass}"></span>
                </div>
                <div class="text-2xl font-bold text-gray-900 mb-1">${value}<span class="text-sm font-normal text-gray-600">${unit}</span></div>
                <p class="text-sm text-gray-600">${description || ''}</p>
            </div>
        `;
    }
    
    function populateCoreMetrics(data, testType) {
        const container = document.getElementById('core-metrics');
        let html = '';
        
        if (testType === 'basic') {
            const metrics = data.performance_metrics || {};
            html += createMetricCard(
                'Load Time', 
                Math.round(metrics.load_time_ms || 0), 
                'ms',
                metrics.load_time_ms <= 3000 ? 'good' : metrics.load_time_ms <= 5000 ? 'needs_improvement' : 'poor',
                'Total page load time',
                'clock'
            );
            
            html += createMetricCard(
                'TTFB', 
                Math.round(metrics.ttfb_ms || 0), 
                'ms',
                metrics.ttfb_ms <= 800 ? 'good' : metrics.ttfb_ms <= 1800 ? 'needs_improvement' : 'poor',
                'Time to First Byte',
                'zap'
            );
            
            html += createMetricCard(
                'Page Size', 
                Math.round(metrics.response_size_kb || 0), 
                'KB',
                metrics.response_size_kb <= 1000 ? 'good' : metrics.response_size_kb <= 3000 ? 'needs_improvement' : 'poor',
                'Total page size',
                'file'
            );
            
            html += createMetricCard(
                'Requests', 
                (data.resource_analysis?.total_external_requests || 0), 
                '',
                data.resource_analysis?.total_external_requests <= 50 ? 'good' : data.resource_analysis?.total_external_requests <= 100 ? 'needs_improvement' : 'poor',
                'External requests',
                'globe'
            );
            
        } else if (testType === 'core_web_vitals') {
            const cwv = data.core_web_vitals || {};
            
            if (cwv.lcp) {
                html += createMetricCard(
                    'LCP', 
                    cwv.lcp.value, 
                    's',
                    cwv.lcp.status,
                    'Largest Contentful Paint',
                    'image'
                );
            }
            
            if (cwv.fid) {
                html += createMetricCard(
                    'FID', 
                    cwv.fid.value, 
                    'ms',
                    cwv.fid.status,
                    'First Input Delay',
                    'mouse-pointer'
                );
            }
            
            if (cwv.cls) {
                html += createMetricCard(
                    'CLS', 
                    cwv.cls.value, 
                    '',
                    cwv.cls.status,
                    'Cumulative Layout Shift',
                    'move'
                );
            }
            
            if (cwv.fcp) {
                html += createMetricCard(
                    'FCP', 
                    cwv.fcp.value, 
                    's',
                    cwv.fcp.status,
                    'First Contentful Paint',
                    'eye'
                );
            }
            
        } else if (testType === 'comprehensive') {
            const summary = data.performance_summary || {};
            
            html += createMetricCard(
                'Speed Score', 
                summary.speed_score || 0, 
                '/100',
                summary.speed_score >= 80 ? 'good' : summary.speed_score >= 60 ? 'needs_improvement' : 'poor',
                'Overall speed performance',
                'gauge'
            );
            
            html += createMetricCard(
                'CWV Score', 
                summary.cwv_score || 0, 
                '/100',
                summary.cwv_score >= 80 ? 'good' : summary.cwv_score >= 60 ? 'needs_improvement' : 'poor',
                'Core Web Vitals score',
                'target'
            );
            
            html += createMetricCard(
                'Overall Grade', 
                summary.overall_grade || 'N/A', 
                '',
                summary.overall_grade >= 'A' ? 'good' : summary.overall_grade >= 'B' ? 'needs_improvement' : 'poor',
                'Combined performance grade',
                'award'
            );
            
            const opportunities = data.optimization_opportunities || [];
            html += createMetricCard(
                'Opportunities', 
                opportunities.length, 
                '',
                opportunities.length <= 2 ? 'good' : opportunities.length <= 5 ? 'needs_improvement' : 'poor',
                'Optimization opportunities',
                'trending-up'
            );
        }
        
        container.innerHTML = html;
        
        // Re-initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    function populateBasicAnalysis(data) {
        populateOverviewTab(data);
        populateTechnicalTab(data);
        populateRecommendations(data);
    }
    
    function populateCoreWebVitalsAnalysis(data) {
        populateCWVTab(data);
        populateCWVRecommendations(data);
    }
    
    function populateComprehensiveAnalysis(data) {
        populateOverviewTab(data.detailed_metrics?.speed_analysis || {});
        populateCWVTab(data.detailed_metrics?.cwv_analysis || {});
        populateTechnicalTab(data.detailed_metrics?.speed_analysis || {}, data.technical_insights || {});
        populateOpportunitiesTab(data.optimization_opportunities || []);
        populateCompetitiveTab(data.competitive_insights || {});
    }
    
    function populateOverviewTab(data) {
        const content = document.getElementById('overview-content');
        const performance = data.performance_metrics || {};
        const pageAnalysis = data.page_analysis || {};
        const resourceAnalysis = data.resource_analysis || {};
        
        let html = '';
        
        html += createMetricCard(
            'Load Time', 
            Math.round(performance.load_time_ms || 0), 
            'ms',
            performance.load_time_ms <= 3000 ? 'good' : 'needs_improvement',
            'Complete page load time'
        );
        
        html += createMetricCard(
            'Page Size', 
            Math.round(performance.response_size_kb || 0), 
            'KB',
            performance.response_size_kb <= 1000 ? 'good' : 'needs_improvement',
            'Total page weight'
        );
        
        html += createMetricCard(
            'DOM Elements', 
            pageAnalysis.dom_elements || 0, 
            '',
            pageAnalysis.dom_elements <= 1500 ? 'good' : 'needs_improvement',
            'Number of DOM elements'
        );
        
        content.innerHTML = html;
    }
    
    function populateCWVTab(data) {
        const content = document.getElementById('cwv-content');
        const cwv = data.core_web_vitals || {};
        
        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
        
        Object.entries(cwv).forEach(([metric, data]) => {
            if (data && typeof data === 'object' && data.value !== undefined) {
                html += `
                    <div class="cwv-metric ${data.status} bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-800">${data.description}</h4>
                            <span class="status-indicator status-${data.status}"></span>
                        </div>
                        <div class="text-2xl font-bold text-gray-900 mb-1">
                            ${data.value}${data.unit}
                        </div>
                        <div class="text-sm text-gray-600">
                            Status: <span class="font-medium capitalize">${data.status.replace('_', ' ')}</span>
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        
        if (data.recommendations && data.recommendations.length > 0) {
            html += '<div class="mt-6"><h4 class="font-semibold text-gray-800 mb-3">Core Web Vitals Recommendations</h4>';
            html += '<ul class="space-y-2">';
            data.recommendations.forEach(rec => {
                html += `<li class="flex items-start space-x-2"><i data-lucide="check-circle" class="w-4 h-4 text-green-600 mt-1 flex-shrink-0"></i><span class="text-gray-700">${rec}</span></li>`;
            });
            html += '</ul></div>';
        }
        
        content.innerHTML = html;
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    function populateTechnicalTab(data, technicalInsights) {
        const content = document.getElementById('technical-content');
        const performance = data.performance_metrics || {};
        const pageAnalysis = data.page_analysis || {};
        const resourceAnalysis = data.resource_analysis || {};
        const technical = technicalInsights || {};
        
        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
        
        // Server Information
        html += `
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-800 mb-3">Server Information</h4>
                <div class="space-y-2 text-sm">
                    <div><span class="text-gray-600">Server:</span> <span class="font-medium">${performance.server || 'Unknown'}</span></div>
                    <div><span class="text-gray-600">Status Code:</span> <span class="font-medium">${performance.status_code || 'Unknown'}</span></div>
                    <div><span class="text-gray-600">Content Encoding:</span> <span class="font-medium">${performance.content_encoding || 'None'}</span></div>
                    <div><span class="text-gray-600">Redirects:</span> <span class="font-medium">${performance.redirects || 0}</span></div>
                </div>
            </div>
        `;
        
        // Resource Summary
        html += `
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-800 mb-3">Resource Summary</h4>
                <div class="space-y-2 text-sm">
                    <div><span class="text-gray-600">Images:</span> <span class="font-medium">${pageAnalysis.image_count || 0}</span></div>
                    <div><span class="text-gray-600">Scripts:</span> <span class="font-medium">${pageAnalysis.script_count || 0}</span></div>
                    <div><span class="text-gray-600">Stylesheets:</span> <span class="font-medium">${pageAnalysis.stylesheet_count || 0}</span></div>
                    <div><span class="text-gray-600">External Requests:</span> <span class="font-medium">${resourceAnalysis.total_external_requests || 0}</span></div>
                </div>
            </div>
        `;
        
        html += '</div>';
        content.innerHTML = html;
    }
    
    function populateRecommendations(data) {
        const content = document.getElementById('opportunities-content');
        const recommendations = data.recommendations || [];
        
        if (recommendations.length === 0) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="check-circle" class="w-12 h-12 text-green-500 mx-auto mb-4"></i>
                    <p class="text-gray-600">Great job! No major performance issues detected.</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="space-y-4">';
        
        recommendations.forEach((recommendation, index) => {
            html += `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex items-start space-x-3">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"></i>
                        <div>
                            <p class="text-gray-700">${recommendation}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    function populateCWVRecommendations(data) {
        populateRecommendations(data);
    }
    
    function populateOpportunitiesTab(opportunities) {
        const content = document.getElementById('opportunities-content');
        
        if (opportunities.length === 0) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="thumbs-up" class="w-12 h-12 text-green-500 mx-auto mb-4"></i>
                    <p class="text-gray-600">Excellent! No major optimization opportunities found.</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="space-y-4">';
        
        opportunities.forEach(opportunity => {
            const impactColor = opportunity.impact === 'High' ? 'red' : opportunity.impact === 'Medium' ? 'yellow' : 'blue';
            const effortColor = opportunity.effort === 'High' ? 'red' : opportunity.effort === 'Medium' ? 'yellow' : 'green';
            
            html += `
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <div class="flex items-start justify-between mb-3">
                        <h4 class="font-semibold text-gray-800">${opportunity.type}</h4>
                        <div class="flex space-x-2">
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${impactColor}-100 text-${impactColor}-800">
                                ${opportunity.impact} Impact
                            </span>
                            <span class="px-2 py-1 rounded text-xs font-medium bg-${effortColor}-100 text-${effortColor}-800">
                                ${opportunity.effort} Effort
                            </span>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-3">${opportunity.description}</p>
                    ${opportunity.potential_savings_kb ? `<p class="text-sm text-gray-600">Potential savings: ${opportunity.potential_savings_kb}KB</p>` : ''}
                    ${opportunity.potential_savings_ms ? `<p class="text-sm text-gray-600">Potential time savings: ${opportunity.potential_savings_ms}ms</p>` : ''}
                    ${opportunity.potential_savings_percent ? `<p class="text-sm text-gray-600">Potential improvement: ${opportunity.potential_savings_percent}%</p>` : ''}
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
    }
    
    function populateCompetitiveTab(competitive) {
        const content = document.getElementById('competitive-content');
        
        if (Object.keys(competitive).length === 0) {
            content.innerHTML = `
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-8 text-center">
                    <i data-lucide="lock" class="w-12 h-12 text-purple-600 mx-auto mb-4"></i>
                    <h4 class="text-xl font-semibold text-purple-800 mb-2">Competitive Analysis</h4>
                    <p class="text-purple-600 mb-4">Unlock competitive performance insights including:</p>
                    <ul class="text-left text-purple-700 space-y-2 mb-6 max-w-md mx-auto">
                        <li>• Industry performance benchmarks</li>
                        <li>• Percentile ranking analysis</li>
                        <li>• Competitive advantage opportunities</li>
                        <li>• Market position assessment</li>
                    </ul>
                    <a href="/pricing" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-colors">
                        <i data-lucide="star" class="w-5 h-5 mr-2"></i>
                        Upgrade to Pro
                    </a>
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="bg-gray-50 rounded-lg p-6">
                <h4 class="font-semibold text-gray-800 mb-4">Industry Benchmarks</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900">${competitive.your_percentile || 0}</div>
                        <div class="text-sm text-gray-600">Your Percentile</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900">${competitive.industry_average || 0}</div>
                        <div class="text-sm text-gray-600">Industry Average</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gray-900">${competitive.top_10_percent_threshold || 0}</div>
                        <div class="text-sm text-gray-600">Top 10% Threshold</div>
                    </div>
                </div>
                ${competitive.recommendation ? `
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-blue-800">${competitive.recommendation}</p>
                    </div>
                ` : ''}
            </div>
        `;
        
        content.innerHTML = html;
    }
    
    function showError(message) {
        resultsContent.style.display = 'block';
        resultsContent.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
                <i data-lucide="alert-circle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                <h3 class="text-lg font-semibold text-red-800 mb-2">Speed Test Failed</h3>
                <p class="text-red-600">${message}</p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    Try Again
                </button>
            </div>
        `;
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
