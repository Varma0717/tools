{% extends 'base.html' %}

{% block title %}
  Business Dashboard - Super SEO Toolkit
{% endblock %}

{% block head %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .metric-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .metric-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .metric-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .revenue-card {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .usage-card {
      background: linear-gradient(135deg, #daac40 0%, #b89627 100%);
    }
    
    .conversion-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .competitive-card {
      background: linear-gradient(135deg, #fd746c 0%, #ff9068 100%);
    }
    
    .chart-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .tool-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .tool-item:last-child {
      border-bottom: none;
    }
    
    .progress-bar-custom {
      background: #e9ecef;
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
      margin-top: 5px;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #daac40, #b89627);
      height: 100%;
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .competitive-advantage {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      border-radius: 15px;
      padding: 30px;
      margin: 30px 0;
    }
    
    .strategy-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h2 mb-0">
        <i class="fas fa-chart-line text-primary"></i>
        Business Intelligence Dashboard
      </h1>
      <div class="btn-group">
        <a href="{{ url_for('business.business_strategy') }}" class="btn btn-outline-primary"><i class="fas fa-lightbulb"></i> Strategy</a>
        <a href="{{ url_for('pricing.pricing') }}" class="btn btn-primary"><i class="fas fa-dollar-sign"></i> Pricing</a>
      </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="kpi-grid">
      <!-- Revenue Metrics -->
      <div class="metric-card revenue-card">
        <div class="metric-value">${{ '%.2f'|format(mrr) }}</div>
        <div class="metric-label">Monthly Recurring Revenue</div>
        <small class="mt-2 d-block">{{ active_subscriptions }} active subscriptions</small>
      </div>

      <!-- Usage Metrics -->
      <div class="metric-card usage-card">
        <div class="metric-value">{{ total_usage_month }}</div>
        <div class="metric-label">Tool Uses This Month</div>
        <small class="mt-2 d-block">{{ total_usage_today }} today, {{ total_usage_week }} this week</small>
      </div>

      <!-- Conversion Rate -->
      <div class="metric-card conversion-card">
        <div class="metric-value">{{ '%.1f'|format(conversion_rate) }}%</div>
        <div class="metric-label">Conversion Rate</div>
        <small class="mt-2 d-block">{{ total_users }} total users</small>
      </div>

      <!-- Monetization Opportunity -->
      <div class="metric-card competitive-card">
        <div class="metric-value">{{ limit_blocks_month }}</div>
        <div class="metric-label">Limit Blocks This Month</div>
        <small class="mt-2 d-block">${{ '%.0f'|format(projected_monthly_revenue) }} potential revenue</small>
      </div>
    </div>

    <div class="row">
      <!-- Subscription Breakdown -->
      <div class="col-lg-6">
        <div class="chart-container">
          <h5 class="mb-3">Subscription Breakdown</h5>
          <canvas id="subscriptionChart" width="400" height="200"></canvas>
          <div class="mt-3">
            <div class="row text-center">
              <div class="col-4">
                <div class="h6 mb-0">{{ pro_subs }}</div>
                <small class="text-muted">Pro ($9.99)</small>
              </div>
              <div class="col-4">
                <div class="h6 mb-0">{{ premium_subs }}</div>
                <small class="text-muted">Premium ($19.99)</small>
              </div>
              <div class="col-4">
                <div class="h6 mb-0">{{ enterprise_subs }}</div>
                <small class="text-muted">Enterprise ($49.99)</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Usage Segmentation -->
      <div class="col-lg-6">
        <div class="chart-container">
          <h5 class="mb-3">User Segmentation (30 days)</h5>
          <canvas id="usageSegmentChart" width="400" height="200"></canvas>
          <div class="mt-3">
            <div class="row text-center">
              <div class="col-4">
                <div class="h6 mb-0">{{ anonymous_usage }}</div>
                <small class="text-muted">Anonymous</small>
              </div>
              <div class="col-4">
                <div class="h6 mb-0">{{ registered_usage }}</div>
                <small class="text-muted">Registered</small>
              </div>
              <div class="col-4">
                <div class="h6 mb-0">{{ premium_usage }}</div>
                <small class="text-muted">Premium</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Popular Tools -->
    <div class="row">
      <div class="col-lg-8">
        <div class="chart-container">
          <h5 class="mb-3">Usage Trends (30 days)</h5>
          <canvas id="usageTrendChart" width="800" height="300"></canvas>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="chart-container">
          <h5 class="mb-3">Most Popular Tools</h5>
          <div class="popular-tools">
            {% for tool in popular_tools[:10] %}
              <div class="tool-item">
                <div>
                  <div class="font-weight-bold">{{ tool.tool_name }}</div>
                  <small class="text-muted">{{ tool.total_uses }} uses</small>
                </div>
                <div class="text-right">
                  <div class="progress-bar-custom" style="width: 80px;">
                    <div class="progress-fill" style="width: {{ (tool.total_uses / popular_tools.0.total_uses * 100)|round }}%"></div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Competitive Advantage -->
    <div class="competitive-advantage">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <h3 class="mb-3">Competitive Advantage Analysis</h3>
          <div class="row">
            <div class="col-md-4">
              <div class="h4 text-warning">{{ competitive_data.tool_advantage }}%</div>
              <p class="mb-2">More Tools</p>
              <small>{{ competitive_data.our_tools }} vs {{ competitive_data.seoptimer_tools }} (SEOptimer)</small>
            </div>
            <div class="col-md-4">
              <div class="h4 text-success">{{ competitive_data.price_advantage }}%</div>
              <p class="mb-2">Lower Cost</p>
              <small>${{ competitive_data.our_price }} vs ${{ competitive_data.seoptimer_price }}</small>
            </div>
            <div class="col-md-4">
              <div class="h4 text-info">4-in-1</div>
              <p class="mb-2">Platform</p>
              <small>SEO + Content + Technical + Security</small>
            </div>
          </div>
        </div>
        <div class="col-lg-4 text-center">
          <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
          <h5>Market Leader Potential</h5>
          <p class="mb-0">Best value proposition in the SEO tools market</p>
        </div>
      </div>
    </div>

    <!-- Revenue Forecast -->
    <div class="strategy-section">
      <h4 class="mb-3">Revenue Forecast & Strategy</h4>
      <div class="row">
        <div class="col-lg-8">
          <canvas id="revenueProjectionChart" width="800" height="300"></canvas>
        </div>
        <div class="col-lg-4">
          <div class="bg-white p-3 rounded">
            <h6>Key Strategies</h6>
            <ul class="list-unstyled">
              <li class="mb-2">
                <i class="fas fa-check text-success me-2"></i>
                Freemium model to drive adoption
              </li>
              <li class="mb-2">
                <i class="fas fa-check text-success me-2"></i>
                Usage limits create upgrade pressure
              </li>
              <li class="mb-2">
                <i class="fas fa-check text-success me-2"></i>
                80% cost advantage over competitors
              </li>
              <li class="mb-2">
                <i class="fas fa-check text-success me-2"></i>
                9x more tools than SEOptimer
              </li>
              <li class="mb-2">
                <i class="fas fa-check text-success me-2"></i>
                All-in-one platform positioning
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
// Subscription Breakdown Chart
const subscriptionCtx = document.getElementById('subscriptionChart').getContext('2d');
new Chart(subscriptionCtx, {
    type: 'doughnut',
    data: {
        labels: ['Pro', 'Premium', 'Enterprise'],
        datasets: [{
            data: [{{ pro_subs }}, {{ premium_subs }}, {{ enterprise_subs }}],
            backgroundColor: ['#DAAC40', '#28a745', '#17a2b8'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Usage Segmentation Chart
const usageSegmentCtx = document.getElementById('usageSegmentChart').getContext('2d');
new Chart(usageSegmentCtx, {
    type: 'pie',
    data: {
        labels: ['Anonymous', 'Registered', 'Premium'],
        datasets: [{
            data: [{{ anonymous_usage }}, {{ registered_usage }}, {{ premium_usage }}],
            backgroundColor: ['#6c757d', '#DAAC40', '#28a745'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Usage Trend Chart
const usageTrendCtx = document.getElementById('usageTrendChart').getContext('2d');
const usageData = {{ daily_usage|safe }};

new Chart(usageTrendCtx, {
    type: 'line',
    data: {
        labels: usageData.map(d => d.date),
        datasets: [
            {
                label: 'Total Uses',
                data: usageData.map(d => d.uses),
                borderColor: '#DAAC40',
                backgroundColor: 'rgba(218, 172, 64, 0.1)',
                tension: 0.4
            },
            {
                label: 'Limit Blocks',
                data: usageData.map(d => d.blocks),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Revenue Projection Chart
const revenueProjectionCtx = document.getElementById('revenueProjectionChart').getContext('2d');

// Fetch revenue forecast data
fetch('/business/api/revenue-forecast')
    .then(response => response.json())
    .then(data => {
        new Chart(revenueProjectionCtx, {
            type: 'line',
            data: {
                labels: Array.from({length: 12}, (_, i) => `Month ${i + 1}`),
                datasets: [
                    {
                        label: 'Conservative',
                        data: data.conservative.map(d => d.revenue),
                        borderColor: '#6c757d',
                        backgroundColor: 'rgba(108, 117, 125, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Realistic',
                        data: data.realistic.map(d => d.revenue),
                        borderColor: '#DAAC40',
                        backgroundColor: 'rgba(218, 172, 64, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Optimistic',
                        data: data.optimistic.map(d => d.revenue),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    });

// Auto-refresh data every 5 minutes
setInterval(() => {
    location.reload();
}, 300000);
</script>
{% endblock %}
