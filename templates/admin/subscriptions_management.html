{% extends "admin/base.html" %}

{% block title %}Subscriptions Management - Admin Dashboard{% endblock %}

{% block header %}Subscriptions Management{% endblock %}
{% block subtitle %}Manage subscription plans and user subscriptions{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Quick Actions -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex flex-wrap gap-3">
      <a href="{{ url_for('admin_orders.subscription_plans_create') }}" 
         class="inline-flex items-center px-4 py-2 bg-[#DAAC40] text-gray-900 font-medium rounded-lg hover:bg-[#b89627] transition-colors duration-200">
        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
        Create Plan
      </a>
    </div>
  </div>

  <!-- Subscription Plans -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Subscription Plans</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Billing Cycle</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Daily Usage</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% if plans %}
            {% for plan in plans %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ plan.name }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${{ plan.price }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">{{ plan.billing_cycle.title() }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">{{ plan.max_daily_usage }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                       {% if plan.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                  {{ 'Active' if plan.is_active else 'Inactive' }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-2">
                  <button onclick="editPlan({{ plan.id }})" class="text-[#DAAC40] hover:text-[#b89627]">
                    <i data-lucide="edit" class="w-4 h-4"></i>
                  </button>
                  <button onclick="togglePlanStatus({{ plan.id }})" class="text-blue-600 hover:text-blue-700">
                    <i data-lucide="toggle-{{ 'left' if plan.is_active else 'right' }}" class="w-4 h-4"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                <i data-lucide="credit-card" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                <p>No subscription plans found</p>
                <a href="{{ url_for('admin_orders.subscription_plans_create') }}" class="text-[#DAAC40] hover:text-[#b89627]">Create your first plan</a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- User Subscriptions -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">User Subscriptions</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% if user_subscriptions %}
            {% for subscription in user_subscriptions %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ subscription.user.username if subscription.user else 'N/A' }}</div>
                <div class="text-sm text-gray-500">{{ subscription.user.email if subscription.user else 'N/A' }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">{{ subscription.plan.name if subscription.plan else 'N/A' }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                       {% if subscription.status == 'active' %}bg-green-100 text-green-800
                       {% elif subscription.status == 'cancelled' %}bg-red-100 text-red-800
                       {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                  {{ subscription.status.title() if subscription.status else 'Unknown' }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ subscription.start_date.strftime('%Y-%m-%d') if subscription.start_date else 'N/A' }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ subscription.end_date.strftime('%Y-%m-%d') if subscription.end_date else 'N/A' }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-2">
                  <button onclick="viewSubscription({{ subscription.id }})" class="text-[#DAAC40] hover:text-[#b89627]">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                  </button>
                  {% if subscription.status == 'active' %}
                  <button onclick="cancelSubscription({{ subscription.id }})" class="text-red-600 hover:text-red-700">
                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                <i data-lucide="users" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                <p>No user subscriptions found</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function editPlan(planId) {
    // Implement plan editing
    window.location.href = `/admin/subscriptions/plans/edit/${planId}`;
}

function togglePlanStatus(planId) {
    if (confirm('Are you sure you want to toggle this plan status?')) {
        fetch(`/admin/api/subscription-plans/${planId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error toggling plan status: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error toggling plan status');
        });
    }
}

function viewSubscription(subscriptionId) {
    // Implement subscription viewing
    window.location.href = `/admin/subscriptions/view/${subscriptionId}`;
}

function cancelSubscription(subscriptionId) {
    if (confirm('Are you sure you want to cancel this subscription?')) {
        fetch(`/admin/api/subscriptions/${subscriptionId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error cancelling subscription: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error cancelling subscription');
        });
    }
}
</script>
{% endblock %}
