{% extends "admin/base.html" %}

{% block title %}Manage Posts - Admin Panel{% endblock %}
{% block header %}Posts Management{% endblock %}
{% block subtitle %}Create, edit and manage your blog posts{% endblock %}

{% block content %}
<!-- Quick Actions -->
<div class="flex flex-wrap gap-3 mb-6">
  <a href="{{ url_for('admin_content.posts_create') }}" 
     class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-[#DAAC40] to-[#b89627] hover:from-[#b89627] hover:to-[#DAAC40] text-white text-sm font-medium rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200">
    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>
    Create New Post
  </a>
  <button onclick="refreshPosts()" class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 shadow-sm hover:shadow-md transition-all duration-200">
    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
    Refresh
  </button>
  
  <!-- Bulk Actions (Hidden by default) -->
  <div id="bulk-actions" class="hidden">
    <button onclick="openBulkActionsModal()" class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg shadow-sm transition-all duration-200">
      <i data-lucide="check-square" class="w-4 h-4 mr-2"></i>
      Actions (<span id="selected-count">0</span>)
    </button>
  </div>
</div>

<!-- Posts Overview Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Total Posts</p>
        <p class="text-2xl font-bold text-gray-900">{{ posts.total if posts.total else 0 }}</p>
      </div>
      <div class="w-12 h-12 bg-[#DAAC40]/10 rounded-lg flex items-center justify-center">
        <i data-lucide="file-text" class="w-6 h-6 text-[#DAAC40]"></i>
      </div>
    </div>
  </div>
  
  <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Current Page</p>
        <p class="text-2xl font-bold text-gray-900">{{ posts.items|length if posts.items else 0 }}</p>
      </div>
      <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
        <i data-lucide="file" class="w-6 h-6 text-blue-600"></i>
      </div>
    </div>
  </div>
  
  <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:shadow-lg transition-all duration-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Pages</p>
        <p class="text-2xl font-bold text-gray-900">{{ posts.pages if posts.pages else 1 }}</p>
      </div>
      <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
        <i data-lucide="edit-3" class="w-6 h-6 text-yellow-600"></i>
      </div>
    </div>
  </div>
</div>

<!-- Posts Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900">All Posts</h3>
      <div class="flex items-center space-x-3">
        <form method="GET" action="{{ url_for('admin_content.posts_list') }}" class="flex items-center space-x-2">
          <div class="relative">
            <input type="text" name="search" value="{{ search or '' }}" placeholder="Search posts..." 
                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#DAAC40] focus:border-transparent text-sm">
            <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
          </div>
          <button type="submit" class="px-4 py-2 bg-gradient-to-r from-[#DAAC40] to-[#b89627] hover:from-[#b89627] hover:to-[#DAAC40] text-white text-sm rounded-lg transition-all duration-200">
            Search
          </button>
          {% if search %}
            <a href="{{ url_for('admin_content.posts_list') }}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-lg transition-all duration-200">
              Clear
            </a>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
  
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <input type="checkbox" id="select-all" onchange="toggleAllPosts()" class="rounded border-gray-300 text-[#DAAC40] focus:ring-[#DAAC40]">
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for post in posts.items %}
        <tr class="hover:bg-gray-50 transition-colors duration-150">
          <td class="px-6 py-4">
            <input type="checkbox" id="post-{{ post.id }}" onchange="togglePostSelection({{ post.id }})" class="rounded border-gray-300 text-[#DAAC40] focus:ring-[#DAAC40]">
          </td>
          <td class="px-6 py-4">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10">
                <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-[#DAAC40] to-[#b89627] flex items-center justify-center">
                  <i data-lucide="file-text" class="h-5 w-5 text-white"></i>
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">{{ post.title }}</div>
                <div class="text-sm text-gray-500">{{ post.slug }}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            {{ post.author_name or (post.author.username if post.author else '—') }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            {% if post.categories %}
              {% for category in post.categories %}
                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-1">{{ category.name }}</span>
              {% endfor %}
            {% else %}
              —
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if post.status == 'published' %}
              <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Published</span>
            {% elif post.status == 'draft' %}
              <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">Draft</span>
            {% elif post.status == 'archived' %}
              <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Archived</span>
            {% else %}
              <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">{{ post.status|title }}</span>
            {% endif %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            {{ post.created_at.strftime('%b %d, %Y') if post.created_at else 'N/A' }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex items-center justify-end space-x-3">
              <a href="{{ url_for('admin_content.posts_edit', post_id=post.id) }}" 
                 class="text-[#DAAC40] hover:text-[#b89627] transition-colors duration-200" title="Edit Post">
                <i data-lucide="edit-2" class="w-4 h-4"></i>
              </a>
              <form action="{{ url_for('admin_content.posts_delete', post_id=post.id) }}" method="POST" 
                    onsubmit="return confirm('Are you sure you want to delete this post?');" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="text-red-500 hover:text-red-700 transition-colors duration-200" title="Delete Post">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="px-6 py-12 text-center">
            <div class="flex flex-col items-center">
              <i data-lucide="file-text" class="w-12 h-12 text-gray-300 mb-4"></i>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No posts found</h3>
              <p class="text-gray-500 mb-6">Get started by creating your first blog post.</p>
              <a href="{{ url_for('admin_content.posts_create') }}" 
                 class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-[#DAAC40] to-[#b89627] hover:from-[#b89627] hover:to-[#DAAC40] text-white text-sm font-medium rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>
                Create Your First Post
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  {% if posts.pages > 1 %}
  <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-700">
        Showing {{ posts.per_page * (posts.page - 1) + 1 }} to 
        {{ posts.per_page * (posts.page - 1) + posts.items|length }} of 
        {{ posts.total }} posts
      </div>
      
      <div class="flex space-x-2">
        {% if posts.has_prev %}
          <a href="{{ url_for('admin_content.posts_list', page=posts.prev_num, search=search) }}" 
             class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors duration-200">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
          </a>
        {% endif %}
        
        {% for page_num in posts.iter_pages() %}
          {% if page_num %}
            {% if page_num != posts.page %}
              <a href="{{ url_for('admin_content.posts_list', page=page_num, search=search) }}" 
                 class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors duration-200">
                {{ page_num }}
              </a>
            {% else %}
              <span class="px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-[#DAAC40] to-[#b89627] border border-transparent rounded-md">
                {{ page_num }}
              </span>
            {% endif %}
          {% else %}
            <span class="px-3 py-2 text-sm font-medium text-gray-500">…</span>
          {% endif %}
        {% endfor %}
        
        {% if posts.has_next %}
          <a href="{{ url_for('admin_content.posts_list', page=posts.next_num, search=search) }}" 
             class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors duration-200">
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Bulk Actions Modal -->
<div id="bulkActionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Bulk Actions</h3>
        <button onclick="closeBulkActionsModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
    <div class="p-6">
      <div class="space-y-4">
        <button onclick="bulkAction('publish')" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
          Publish Selected Posts
        </button>
        <button onclick="bulkAction('unpublish')" class="w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors">
          Unpublish Selected Posts
        </button>
        <button onclick="bulkAction('delete')" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
          Delete Selected Posts
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedPosts = new Set();

function refreshPosts() {
  showLoadingState();
  window.location.reload();
}

function showLoadingState() {
  const button = event.target;
  const originalContent = button.innerHTML;
  button.innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>Loading...';
  button.disabled = true;
  
  setTimeout(() => {
    button.innerHTML = originalContent;
    button.disabled = false;
    lucide.createIcons();
  }, 1000);
}

function togglePostSelection(postId) {
  const checkbox = document.getElementById(`post-${postId}`);
  if (checkbox.checked) {
    selectedPosts.add(postId);
  } else {
    selectedPosts.delete(postId);
  }
  updateBulkActionsVisibility();
}

function toggleAllPosts() {
  const masterCheckbox = document.getElementById('select-all');
  const postCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="post-"]');
  
  postCheckboxes.forEach(checkbox => {
    checkbox.checked = masterCheckbox.checked;
    const postId = checkbox.id.replace('post-', '');
    if (masterCheckbox.checked) {
      selectedPosts.add(postId);
    } else {
      selectedPosts.delete(postId);
    }
  });
  updateBulkActionsVisibility();
}

function updateBulkActionsVisibility() {
  const bulkActions = document.getElementById('bulk-actions');
  if (selectedPosts.size > 0) {
    bulkActions.classList.remove('hidden');
    document.getElementById('selected-count').textContent = selectedPosts.size;
  } else {
    bulkActions.classList.add('hidden');
  }
}

function openBulkActionsModal() {
  document.getElementById('bulkActionsModal').classList.remove('hidden');
  document.getElementById('bulkActionsModal').classList.add('flex');
}

function closeBulkActionsModal() {
  document.getElementById('bulkActionsModal').classList.add('hidden');
  document.getElementById('bulkActionsModal').classList.remove('flex');
}

function bulkAction(action) {
  if (selectedPosts.size === 0) return;
  
  const actionText = action === 'delete' ? 'delete' : action;
  if (confirm(`Are you sure you want to ${actionText} ${selectedPosts.size} selected posts?`)) {
    // Show loading state
    showNotification(`Processing ${actionText} action...`, 'info');
    
    // Send request to backend
    fetch('/admin/api/posts/bulk-actions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: action,
        post_ids: Array.from(selectedPosts)
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        showNotification(`✅ ${data.message}`, 'success');
        
        // Clear selection and close modal
        selectedPosts.clear();
        updateBulkActionsVisibility();
        closeBulkActionsModal();
        
        // Refresh the page to show updated data
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showNotification(`❌ Error: ${data.message}`, 'error');
      }
    })
    .catch(error => {
      console.error('Bulk action error:', error);
      showNotification(`❌ Error: ${error.message}`, 'error');
    });
  }
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-0 ${
    type === 'success' ? 'bg-green-500 text-white' :
    type === 'error' ? 'bg-red-500 text-white' :
    'bg-blue-500 text-white'
  }`;
  
  // Create notification content with icon
  const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
  notification.innerHTML = `
    <div class="flex items-center space-x-2">
      <span class="text-lg">${icon}</span>
      <span>${message.replace(/^[✅❌ℹ️]\s*/, '')}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 10);
  
  // Remove after 4 seconds
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 300);
  }, 4000);
}

// Initialize icons when page loads
document.addEventListener('DOMContentLoaded', function() {
  lucide.createIcons();
  
  // Add loading states to form submissions
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        const originalText = submitBtn.textContent;
        submitBtn.innerHTML = '<i class="w-4 h-4 mr-2 animate-spin">⟳</i>Processing...';
        submitBtn.disabled = true;
      }
    });
  });
});
</script>
{% endblock %}
